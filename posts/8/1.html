<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Iron&#39;s Blog | 船新版本的JavaScript（一）：&#96;?.&#96;(Optional Chaining) 和 &#96;??&#96;(Nullish Coalescing Operator)</title>
    <meta name="description" content="Just recording something">
    
    
    <link rel="preload" href="/assets/css/23.styles.40677ac6.css" as="style"><link rel="preload" href="/assets/js/app.0caf2975.js" as="script"><link rel="preload" href="/assets/js/6.58a56d39.js" as="script"><link rel="prefetch" href="/assets/js/0.9f59e96c.js"><link rel="prefetch" href="/assets/js/1.9710c8e3.js"><link rel="prefetch" href="/assets/js/2.717bf58a.js"><link rel="prefetch" href="/assets/js/3.eb3ce0d5.js"><link rel="prefetch" href="/assets/js/4.81a9fd94.js"><link rel="prefetch" href="/assets/js/5.0289cb67.js"><link rel="prefetch" href="/assets/js/7.5fb1dc3c.js"><link rel="prefetch" href="/assets/js/8.af6cf755.js"><link rel="prefetch" href="/assets/js/9.d4b854ad.js"><link rel="prefetch" href="/assets/js/10.f94d82bf.js"><link rel="prefetch" href="/assets/js/11.68ad2dfd.js"><link rel="prefetch" href="/assets/js/12.fe4f1f96.js"><link rel="prefetch" href="/assets/js/13.1594182b.js"><link rel="prefetch" href="/assets/js/14.5e2158c7.js"><link rel="prefetch" href="/assets/js/15.cb7e4c09.js"><link rel="prefetch" href="/assets/js/16.637e1af2.js"><link rel="prefetch" href="/assets/js/17.c68f0f15.js"><link rel="prefetch" href="/assets/js/18.3f6c685d.js"><link rel="prefetch" href="/assets/js/19.5d57c2ad.js"><link rel="prefetch" href="/assets/js/20.725e2252.js"><link rel="prefetch" href="/assets/js/21.c0d37235.js"><link rel="prefetch" href="/assets/js/22.c549c2ec.js">
    <link rel="stylesheet" href="/assets/css/23.styles.40677ac6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Iron's Blog
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><!----></div></header><div class="sidebar-mask"></div><div class="sidebar"><!----><!----></div><div class="page"><div class="content"><h1 id="船新版本的javascript（一）：-optional-chaining-和-nullish-coalescing-operator"><a href="#船新版本的javascript（一）：-optional-chaining-和-nullish-coalescing-operator" aria-hidden="true" class="header-anchor">#</a> 船新版本的JavaScript（一）：<code>?.</code>(Optional Chaining) 和 <code>??</code>(Nullish Coalescing Operator)</h1><p><s>大扎好，我系Iron。Babel 7，介四里没有挽过的船新版本，挤需体验三番钟，里造会干我一样，爱上这门语言</s></p><h2 id="可选链调用-optional-chaining"><a href="#可选链调用-optional-chaining" aria-hidden="true" class="header-anchor">#</a><code>?.</code>可选链调用(Optional Chaining)</h2><h3 id="背景"><a href="#背景" aria-hidden="true" class="header-anchor">#</a> 背景</h3><p>我们经常会遇到这样的情况，我们要去读取一个嵌套的对象中的某个深层的值，但我们必须检验我们访问的“路径”的每个节点是否为<code>null</code>或<code>undefined</code>，这种情况下我们一般是这么来的</p><pre class="language-js"><code><span class="token keyword">const</span> street <span class="token operator">=</span> user<span class="token punctuation">.</span>address <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>address<span class="token punctuation">.</span>street<span class="token punctuation">;</span>
</code></pre><p>如果是foo.bar.biz.bah这样的路径，那么我们得这么写</p><pre class="language-js"><code><span class="token keyword">const</span> bah <span class="token operator">=</span> foo <span class="token operator">&amp;&amp;</span> foo<span class="token punctuation">.</span>bar <span class="token operator">&amp;&amp;</span> foo<span class="token punctuation">.</span>bar<span class="token punctuation">.</span>biz <span class="token operator">&amp;&amp;</span> foo<span class="token punctuation">.</span>bar<span class="token punctuation">.</span>biz<span class="token punctuation">.</span>bah
</code></pre><p>这个提案出现就是为了避免使用 <code>&amp;&amp;</code> 或者<code>||</code>并不断重复“访问路径&quot;中的属性名（就是上面不断出现的<code>foo</code>, <code>bar</code>, <code>biz</code>）</p><h3 id="语法"><a href="#语法" aria-hidden="true" class="header-anchor">#</a> 语法</h3><pre class="language-js"><code><span class="token comment">// 带空指针检查地取静态属性</span>
a<span class="token operator">?</span><span class="token punctuation">.</span>b
<span class="token comment">// 等效于</span>
a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> a<span class="token punctuation">.</span>b
<span class="token comment">// NOTE: null == undefined 会返回ture</span>

<span class="token comment">// 取动态的属性</span>
a<span class="token operator">?</span><span class="token punctuation">.</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span>
<span class="token comment">// 将被转化为</span>
a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> a<span class="token punctuation">[</span>x<span class="token punctuation">]</span>


<span class="token comment">// 检查一个函数的引用是否为空，非空则调用它，否则直接返回undefined</span>
<span class="token comment">// 当然这也可能会抛出异常，显然会出现func既不是函数也不是null也不是undefind的情况</span>
func<span class="token operator">?</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//</span>
func <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h4 id="短路"><a href="#短路" aria-hidden="true" class="header-anchor">#</a> 短路</h4><p><code>?.</code>运算符具有短路的特性。<code>?.</code>左边的值为<code>null</code>或<code>undefined</code>，那么它右边的表达式将不会执行</p><pre class="language-js"><code>a<span class="token operator">?</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token operator">++</span>x<span class="token punctuation">]</span>
<span class="token comment">// 等效于</span>
a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> a<span class="token punctuation">[</span><span class="token operator">++</span>x<span class="token punctuation">]</span>
<span class="token comment">// 当a为null或者undefined时++x不会执行，x不变</span>
</code></pre><p>当短路发生时，不仅短路当前<code>?.</code>的右值，<code>?.</code>之后的所有表达式都会被短路掉</p><pre class="language-js"><code>a<span class="token operator">?</span><span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token operator">++</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>d
<span class="token comment">// 后面的`b.c(++x).d`被短路，++x不会被执行，上面这段代码等效于</span>
a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> a<span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token operator">++</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>d
</code></pre><h4 id="边界：括号"><a href="#边界：括号" aria-hidden="true" class="header-anchor">#</a> 边界：括号</h4><p>括号会为<code>?.</code>的短路行为定一个边界，括号外的调用将不会被短路</p><pre class="language-js"><code><span class="token punctuation">(</span>a<span class="token operator">?</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>c
<span class="token comment">// `.c`在a为null或者undefined的时候也会被调用，因此可能会引发空指针异常</span>
<span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> a<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>c
</code></pre><h4 id="delete"><a href="#delete" aria-hidden="true" class="header-anchor">#</a> delete</h4><pre class="language-js"><code><span class="token keyword">delete</span> a<span class="token operator">?</span><span class="token punctuation">.</span>b
<span class="token comment">// 我们会得到下面的</span>
a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> undefined <span class="token punctuation">:</span> <span class="token keyword">delete</span> a<span class="token punctuation">.</span>b
<span class="token comment">// 不过delete删掉一个null或者undefined也不会报错</span>
</code></pre><h2 id="（空值合并）-nullish-coalescing-operator"><a href="#（空值合并）-nullish-coalescing-operator" aria-hidden="true" class="header-anchor">#</a><code>??</code>（空值合并）(Nullish Coalescing Operator)</h2><h3 id="背景-2"><a href="#背景-2" aria-hidden="true" class="header-anchor">#</a> 背景</h3><p>首先，我们先下个定义，一个<code>Nullish</code>的值，即这个值为<code>null</code>或<code>undefined</code>，一个<code>falsy</code>的值，即在Boolean上下文中可被认定为<code>false</code>
的值，他们是（<code>''</code>, <code>false</code>, <code>0</code>, <code>null</code>, <code>undefined</code>, <code>NaN</code>, <code>document.all</code>）
当我们用上面所说的<code>?.</code>(optional chaining operator)运算符去读取属性有时会返回<code>null</code>或<code>undefined</code>，这个时候我们可能需要一个默认值
举个例子
假设我们有这么一个对象</p><pre class="language-js"><code><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span>
  settings<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    nullValue<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
    animationDuration<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    headerText<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    showSplashScreen<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>似乎我们可以用<code>||</code>运算符给<code>?.</code>(optional training operator)的结果指定一个默认值</p><pre class="language-js"><code><span class="token keyword">const</span> undefinedValue <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>undefinedValue <span class="token operator">||</span> <span class="token string">'some other default'</span><span class="token punctuation">;</span> <span class="token comment">// 结果是'some other result'</span>
<span class="token keyword">const</span> nullValue <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>nullValue <span class="token operator">||</span> <span class="token string">'some other default'</span><span class="token punctuation">;</span> <span class="token comment">// 结果也是'some other result'</span>
</code></pre><p>上面两种情况可以按照我们想象的方式工作
但下面三种情况，<code>?.</code>运算符的结果为<code>falsy</code>但不为<code>nullish</code>，但最后还是可能返回<code>||</code>的右值</p><pre class="language-js"><code><span class="token keyword">const</span> headerText <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>headerText <span class="token operator">||</span> <span class="token string">'Hello, world!'</span><span class="token punctuation">;</span> <span class="token comment">// 当`||`左值为''（空字符串）时，表达式结果：'Hello, world'</span>
<span class="token keyword">const</span> animationDuration <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>animationDuration <span class="token operator">||</span> <span class="token number">300</span><span class="token punctuation">;</span> <span class="token comment">// 左值为0时，表达式结果: 300</span>
<span class="token keyword">const</span> showSplashScreen <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>showSplashScreen <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 左值为false时，表达式结果为true</span>
</code></pre><p>因此使用<code>||</code>给<code>?.</code>的结果指定默认值时，当左值为<code>falsy</code>且不是<code>nullish</code>,<code>||</code>运算依旧会返回右边的默认值，这与我们所希望的，只有当<code>?.</code>结果为<code>nullish</code>时才返回一个默认值的意愿是相左的。
当然我们可以直接用三目运算符避免这种情况。<code>??</code>运算符的出现是为了更好地处理左值为非<code>nullish</code>但为<code>falsy</code>时需要返回左值的情况</p><h3 id="语法-2"><a href="#语法-2" aria-hidden="true" class="header-anchor">#</a> 语法</h3><p>这个运算符的语法非常简单
以上面的例子为例，<code>??</code>运算符的左值为null或undefined时返回右值，否则返回左值</p><pre class="language-js"><code><span class="token keyword">const</span> undefinedValue <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>undefinedValue <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'some other default'</span><span class="token punctuation">;</span> <span class="token comment">// some other default'</span>
<span class="token keyword">const</span> nullValue <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>nullValue <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'some other default'</span><span class="token punctuation">;</span> <span class="token comment">// 'some other default'</span>
<span class="token comment">// 下面三个左值为非null且非undefined，返回左值</span>
<span class="token keyword">const</span> headerText <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>headerText <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'Hello, world!'</span><span class="token punctuation">;</span> <span class="token comment">// : ''</span>
<span class="token keyword">const</span> animationDuration <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>animationDuration <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">300</span><span class="token punctuation">;</span> <span class="token comment">//  0</span>
<span class="token keyword">const</span> showSplashScreen <span class="token operator">=</span> response<span class="token punctuation">.</span>settings<span class="token operator">?</span><span class="token punctuation">.</span>showSplashScreen <span class="token operator">?</span><span class="token operator">?</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre><h2 id="如何在代码中用上-和"><a href="#如何在代码中用上-和" aria-hidden="true" class="header-anchor">#</a> 如何在代码中用上<code>?.</code>和<code>??</code></h2><p>babel已经实现了这两个语法，他们可以用babel7的插件来编译到兼容的语法上</p><h3 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h3><pre class="language-text"><code>npm install --save-dev @babel/plugin-proposal-optional-chaining
npm install --save-dev @babel/plugin-proposal-nullish-coalescing-operator
# 用yarn装也无所谓
</code></pre><h3 id="配置"><a href="#配置" aria-hidden="true" class="header-anchor">#</a> 配置</h3><p>在.babelrc里加上这么两句</p><pre class="language-text"><code>{
  &quot;plugins&quot;: [&quot;@babel/plugin-proposal-nullish-coalescing-operator&quot;, &quot;@babel/plugin-proposal-optional-chaining&quot;]
}
</code></pre><p>如果有webpack的话需要在webpack 中<code>babel-loader</code>的options中加上</p><pre class="language-js"><code><span class="token punctuation">{</span>
  loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/plugin-proposal-nullish-coalescing-operator'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/plugin-proposal-optional-chaining'</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h3><p>最后在命令行里敲<code>webpack</code>或者<code>babel</code>就行了</p><h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2><p><a href="https://babeljs.io/blog/2018/08/27/7.0.0" target="_blank" rel="noopener noreferrer">Babel 7 release announcement</a></p><p><a href="https://github.com/tc39/proposal-optional-chaining" target="_blank" rel="noopener noreferrer">TC39 optional chaining proposal</a></p><p><a href="https://github.com/tc39/proposal-nullish-coalescing" target="_blank" rel="noopener noreferrer">TC39 nullish coalescing operator proposal</a></p><p><a href="https://babeljs.io/docs/en/babel-plugin-proposal-optional-chaining" target="_blank" rel="noopener noreferrer">@babel/plugin-proposal-optional-chaining</a></p><p><a href="https://babeljs.io/docs/en/babel-plugin-proposal-nullish-coalescing-operator" target="_blank" rel="noopener noreferrer"> babel/plugin-proposal-nullish-coalescing-operator</a></p></div><!----><!----></div></div></div>
    <script src="/assets/js/6.58a56d39.js" defer></script><script src="/assets/js/app.0caf2975.js" defer></script>
  </body>
</html>
